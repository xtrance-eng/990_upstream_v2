name: Kernel Build

on: 
  workflow_dispatch: 

  push:
    branches:
      - main
      - ksun
    tags: [ 'v*' ]

jobs: 
  build:
    name:  Build Kernel
    runs-on: ubuntu-latest

    strategy:  
      fail-fast: false
      matrix:
        include:
          - model: x1slte
            branch: main
            variant: ksu
          - model: x1slte
            branch: main
            variant: susfs
          - model: x1slte
            branch: main
            variant: vanilla

          - model: x1s
            branch: main
            variant: ksu
          - model: x1s
            branch: main
            variant: susfs
          - model: x1s
            branch: main
            variant: vanilla

          - model: y2slte
            branch: main
            variant: ksu
          - model: y2slte
            branch: main
            variant: susfs
          - model: y2slte
            branch: main
            variant: vanilla

          - model: y2s
            branch: main
            variant: ksu
          - model: y2s
            branch: main
            variant: susfs
          - model: y2s
            branch: main
            variant: vanilla

          - model: z3s
            branch: main
            variant: ksu
          - model: z3s
            branch: main
            variant: susfs
          - model: z3s
            branch: main
            variant: vanilla

          - model: c1slte
            branch: main
            variant: ksu
          - model: c1slte
            branch: main
            variant: susfs
          - model: c1slte
            branch: main
            variant: vanilla

          - model: c1s
            branch: main
            variant: ksu
          - model: c1s
            branch: main
            variant: susfs
          - model: c1s
            branch: main
            variant: vanilla

          - model: c2slte
            branch: main
            variant: ksu
          - model: c2slte
            branch: main
            variant: susfs
          - model: c2slte
            branch: main
            variant: vanilla

          - model: c2s
            branch: main
            variant: ksu
          - model: c2s
            branch: main
            variant: susfs
          - model: c2s
            branch: main
            variant: vanilla

          - model: r8s
            branch: main
            variant: ksu
          - model: r8s
            branch: main
            variant: susfs
          - model: r8s
            branch: main
            variant: vanilla

          - model: x1slte
            branch: ksun
            variant: ksu
          - model: x1slte
            branch: ksun
            variant: susfs

          - model: x1s
            branch: ksun
            variant: ksu
          - model: x1s
            branch: ksun
            variant: susfs

          - model: y2slte
            branch: ksun
            variant: ksu
          - model: y2slte
            branch: ksun
            variant: susfs

          - model: y2s
            branch: ksun
            variant: ksu
          - model: y2s
            branch: ksun
            variant: susfs

          - model: z3s
            branch: ksun
            variant: ksu
          - model: z3s
            branch: ksun
            variant: susfs

          - model: c1slte
            branch: ksun
            variant: ksu
          - model: c1slte
            branch: ksun
            variant: susfs

          - model: c1s
            branch: ksun
            variant: ksu
          - model: c1s
            branch: ksun
            variant: susfs

          - model: c2slte
            branch: ksun
            variant: ksu
          - model: c2slte
            branch: ksun
            variant: susfs

          - model: c2s
            branch: ksun
            variant: ksu
          - model: c2s
            branch: ksun
            variant: susfs

          - model: r8s
            branch: ksun
            variant: ksu
          - model: r8s
            branch: ksun
            variant: susfs

    steps: 
      # (1) Checkout repository without submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ matrix.branch }}

      - name: Fetch tags explicitly
        run: git fetch --force --tags

      # (2) Install build dependencies
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl \
            zlib1g-dev libc6-dev-i386 x11proto-core-dev \
            libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig cpio

      # (3) Set build flags by variant
      - name: Set build flags
        id: vars
        run:  |
          case "${{ matrix.variant }}" in
            ksu)
              echo "FLAGS=-k y" >> $GITHUB_OUTPUT
              ;;
            susfs)
              echo "FLAGS=-k y -s y" >> $GITHUB_OUTPUT
              ;;
            vanilla)
              echo "FLAGS=-k n" >> $GITHUB_OUTPUT
              ;;
          esac

      # (4) Build kernel
      - name: Run kernel build
        run: |
          chmod +x ./build.sh
          ./build.sh -m ${{ matrix.model }} ${{ steps.vars.outputs.FLAGS }}

      # (5) Extract and prepare artifact
      - name:  Prepare artifact
        id: artifact_name
        run: |
          ZIP_FILE=$(ls build/out/${{ matrix.model }}/*.zip | head -n 1)
          ARTIFACT_NAME=$(basename "$ZIP_FILE" .zip)
          
          # Unzip to a temporary directory
          mkdir -p "artifact-content/$ARTIFACT_NAME"
          unzip -q "$ZIP_FILE" -d "artifact-content/$ARTIFACT_NAME"
          
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Prepared artifact: $ARTIFACT_NAME"

      # (6) Upload kernel artifact
      - name: Upload kernel artifact
        uses:  actions/upload-artifact@v4
        with:
          name:  ${{ steps.artifact_name.outputs.name }}
          path: artifact-content/${{ steps.artifact_name.outputs.name }}/*

  release:
    name: Publish GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest

    steps: 
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with: 
          pattern: ExtremeKRNL-*
          path: kernel-artifacts

      - name: Generate release notes
        run:  |
          cat > release.md <<EOF
          Kernel Information
          - Kernel Version: Linux 4.19.325
          - SuSFS Version: 2.0.0
          - RKSU main Version: 32424
          - RKSU susfs-rksu-master Version: 32359
          - KSUN legacy Version: 32943
          - KSUN legacy-susfs Version: 32943
          - Build Date: $(date +%Y-%m-%d)

          1.2.0 updates:
          - Added KernelSU Next variants too.
          You can download RKSU Manager Here for RKSU:
          https://t.me/rsukrnlsu/1136
          You can download KSUN Manager Here for KernelSU Next:
          https://t.me/ksunext_ci/8387

          Supported Devices
          - Galaxy S20 (x1slte)
          - Galaxy S20 5G (x1s)
          - Galaxy S20+ (y2slte)
          - Galaxy S20+ 5G (y2s)
          - Galaxy S20 Ultra 5G (z3s)
          - Galaxy N20 (c1slte)
          - Galaxy N20 5G (c1s)
          - Galaxy N20 Ultra (c2slte)
          - Galaxy N20 Ultra 5G (c2s)
          - Galaxy S20 FE (r8s)

          Build Variants
          1st is the KSU Next Variant.
          2nd is the KSU Next + SuSFS 2.0.0 variant.
          3rd is the RKSU Variant.
          4th is the RKSU + SuSFS 2.0.0 variant.
          5th is the Vanilla build. fresh kernel, no KSU.

          Build Notes
          - Built via GitHub Actions
          - Total builds: 50 (10 models x 5 variants)
          EOF

      - name:  Repackage for release
        run: |
          mkdir -p release-files
          
          # Repackage each artifact
          for artifact_dir in kernel-artifacts/ExtremeKRNL-*/; do
            ARTIFACT_NAME=$(basename "$artifact_dir")
            echo "Packaging $ARTIFACT_NAME..."
            cd "$artifact_dir"
            zip -r "../../release-files/${ARTIFACT_NAME}.zip" .
            cd ../..
          done
          
          echo "Release files:"
          ls -lh release-files/

      - name:  Create GitHub Release
        uses: softprops/action-gh-release@v2
        with: 
          tag_name: ${{ github.ref_name }}
          name: ExtremeKRNL ${{ github.ref_name }}
          body_path: release.md
          files: release-files/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}