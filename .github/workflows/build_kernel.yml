name: Kernel Build

on: 
  workflow_dispatch: 

  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs: 
  build:
    name:  Build Kernel
    runs-on: ubuntu-latest

    strategy:  
      fail-fast: false
      matrix:
        model: ${{ startsWith(github.ref, 'refs/tags/') && fromJSON('["x1slte", "x1s", "y2slte", "y2s", "z3s", "c1slte", "c1s", "c2slte", "c2s", "r8s"]') || fromJSON('["c2s"]') }}
        variant: [ksu, susfs, vanilla]

    steps: 
      # (1) Checkout repository without submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (2) Install build dependencies
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl \
            zlib1g-dev libc6-dev-i386 x11proto-core-dev \
            libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig cpio

      # (3) Set build flags by variant
      - name: Set build flags
        id: vars
        run:  |
          case "${{ matrix.variant }}" in
            ksu)
              echo "FLAGS=-k y" >> $GITHUB_OUTPUT
              ;;
            susfs)
              echo "FLAGS=-k y -s y" >> $GITHUB_OUTPUT
              ;;
            vanilla)
              echo "FLAGS=-k n" >> $GITHUB_OUTPUT
              ;;
          esac

      # (4) Build kernel
      - name: Run kernel build
        run: |
          chmod +x ./build.sh
          ./build.sh -m ${{ matrix.model }} ${{ steps.vars.outputs.FLAGS }}

      # (5) Extract and prepare artifact
      - name:  Prepare artifact
        id: artifact_name
        run: |
          ZIP_FILE=$(ls build/out/${{ matrix.model }}/*.zip | head -n 1)
          ARTIFACT_NAME=$(basename "$ZIP_FILE" .zip)
          
          # Unzip to a temporary directory
          mkdir -p "artifact-content/$ARTIFACT_NAME"
          unzip -q "$ZIP_FILE" -d "artifact-content/$ARTIFACT_NAME"
          
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Prepared artifact: $ARTIFACT_NAME"

      # (6) Upload kernel artifact
      - name: Upload kernel artifact
        uses:  actions/upload-artifact@v4
        with:
          name:  ${{ steps.artifact_name. outputs.name }}
          path: artifact-content/${{ steps.artifact_name.outputs.name }}/*

      # (7) Save meta information for release (KSU/SUSFS only)
      - name: Save meta information
        if: startsWith(github.ref, 'refs/tags/') && matrix.variant != 'vanilla'
        run:  |
          if [ -d "build/meta" ] && [ "$(ls -A build/meta 2>/dev/null)" ]; then
            mkdir -p release-meta
            cp -r build/meta/* release-meta/
          else
            echo "No meta files found, skipping"
          fi

      # (8) Upload meta for release job only
      - name:  Upload meta for release
        if:  startsWith(github.ref, 'refs/tags/') && matrix.variant != 'vanilla'
        uses: actions/upload-artifact@v4
        with: 
          name: meta-${{ matrix.model }}-${{ matrix.variant }}
          path: release-meta/*
          retention-days:  1

  release:
    name: Publish GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest

    steps: 
      - name:  Download artifacts
        uses: actions/download-artifact@v4
        with: 
          path: artifacts

      - name: Generate release notes
        run:  |
          set -e

          KSU_MAIN="N/A"
          KSU_SUSFS="N/A"
          SUSFS_VERSION="N/A"

          # Find meta files (pick first available)
          for meta_dir in artifacts/meta-*/; do
            if [ -f "$meta_dir/ksu-main.env" ]; then
              source "$meta_dir/ksu-main.env"
              KSU_MAIN="$KSU_MAIN_VERSION"
              break
            fi
          done
          
          for meta_dir in artifacts/meta-*/; do
            if [ -f "$meta_dir/ksu-susfs.env" ]; then
              source "$meta_dir/ksu-susfs.env"
              KSU_SUSFS="$KSU_SUSFS_VERSION"
              SUSFS_VERSION="$SUSFS_VERSION"
              break
            fi
          done

          cat > release.md <<EOF
          Kernel Information
          - Kernel Version: Linux 4.19.325

          Supported Devices
          - Galaxy S20 (x1slte)
          - Galaxy S20 5G (x1s)
          - Galaxy S20+ (y2slte)
          - Galaxy S20+ 5G (y2s)
          - Galaxy S20 Ultra 5G (z3s)
          - Galaxy N20 (c1slte)
          - Galaxy N20 5G (c1s)
          - Galaxy N20 Ultra (c2slte)
          - Galaxy N20 Ultra 5G (c2s)
          - Galaxy S20 FE (r8s)

          KernelSU Integration
          - KernelSU (main)
            - Version: $KSU_MAIN
            - Branch: main

          - KernelSU + SuSFS
            - Version:  $KSU_SUSFS
            - Branch: susfs-rksu-master
            - SuSFS Version: $SUSFS_VERSION

          Build Variants
          1. RKSU
          2. RKSU + SuSFS
          3. Vanilla (no KernelSU)

          Build Notes
          - Built via GitHub Actions
          - Total builds: 30 (10 models x 3 variants)
          EOF

      - name: Repackage for release
        run: |
          mkdir -p release-files
          
          # Repackage each artifact (excluding meta)
          for artifact_dir in artifacts/ExtremeKRNL-*/; do
            if [[ !  "$artifact_dir" =~ meta- ]]; then
              ARTIFACT_NAME=$(basename "$artifact_dir")
              echo "Packaging $ARTIFACT_NAME..."
              cd "$artifact_dir"
              zip -r "../../release-files/${ARTIFACT_NAME}.zip". 
              cd ../..
            fi
          done
          
          echo "Release files:"
          ls -lh release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name:  ${{ github.ref_name }}
          name:  ExtremeKRNL ${{ github.ref_name }}
          body_path: release.md
          files: release-files/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}